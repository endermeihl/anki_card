# Anki 卡片生成器 - 设计文档

## 项目概述

本项目是一个基于 Python 的 Anki 单词卡片自动生成系统。通过调用 DeepSeek API 对英语单词进行深度分析，生成两种类型的学习卡片：
- **学习卡片**：包含词源、音标、记忆逻辑等深度学习内容
- **练习卡片**：包含完形填空、拼写练习、情景问答三种练习形式

## 系统架构

### 目录结构

```
anki_card/
├── main.py                          # 程序入口
├── config.py                        # 配置管理
├── requirements.txt                 # 依赖清单
├── .env                             # 环境变量（API密钥）
├── .env.example                     # 环境变量模板
├── .gitignore                       # Git忽略规则
├── docs/                            # 文档目录
│   ├── 设计文档.md
│   └── 使用文档.md
├── processor/                       # 文件处理模块
│   ├── __init__.py
│   ├── file_scanner.py              # 文件扫描器
│   └── file_archiver.py             # 文件归档器
├── api/                             # API调用模块
│   ├── __init__.py
│   └── deepseek.py                  # DeepSeek客户端
├── generators/                      # CSV生成模块
│   ├── __init__.py
│   ├── learning_csv.py              # 学习卡片生成器
│   └── practice_csv.py              # 练习卡片生成器
└── Anki_Auto_Builder/               # 工作目录
    ├── input/                       # 输入目录
    ├── output/                      # 输出目录
    └── processed/                   # 归档目录
```

### 模块说明

#### 1. 配置模块 (`config.py`)

负责管理所有配置项：
- 目录路径配置
- API 密钥和端点
- 重试策略参数

```python
# 主要配置项
BASE_DIR          # 项目根目录
INPUT_DIR         # 输入文件目录
OUTPUT_DIR        # 输出文件目录
PROCESSED_DIR     # 已处理文件归档目录
DEEPSEEK_API_KEY  # API密钥（从环境变量读取）
MAX_RETRIES = 3   # API调用最大重试次数
```

#### 2. 文件处理模块 (`processor/`)

**file_scanner.py** - 文件扫描器
- `scan_input_files()`: 扫描输入目录中的所有 .txt 文件
- `read_words_from_file()`: 读取单个文件中的单词
- `collect_all_words()`: 汇总所有文件的单词并去重

**file_archiver.py** - 文件归档器
- `archive_file()`: 将处理完成的文件移动到归档目录
- `archive_files()`: 批量归档多个文件
- 归档时自动添加时间戳，避免文件名冲突

#### 3. API模块 (`api/`)

**deepseek.py** - DeepSeek API 客户端
- `generate_card_data()`: 调用 API 生成单词卡片数据
- 内置重试机制（最多3次）
- 返回结构化的 JSON 数据

**API 请求格式：**
```json
{
  "model": "deepseek-chat",
  "messages": [
    {"role": "system", "content": "系统提示词"},
    {"role": "user", "content": "用户提示词"}
  ],
  "response_format": {"type": "json_object"}
}
```

**API 响应格式：**
```json
{
  "learning_data": {
    "phonetic": "音标",
    "meaning": "中文释义",
    "source_code": "词源分析",
    "assimilation": "记忆联想",
    "logic": "使用逻辑",
    "note": "注意事项",
    "example_en": "英文例句",
    "example_cn": "例句翻译"
  },
  "practice_data": {
    "cloze_text": "完形填空句子",
    "cloze_hint": "填空提示",
    "spell_def": "拼写练习定义",
    "scenario_context": "情景描述",
    "scenario_question": "情景问题"
  }
}
```

#### 4. 生成器模块 (`generators/`)

**learning_csv.py** - 学习卡片生成器
- 生成 9 字段 CSV 文件
- 对应 Anki 的 `English_Deep_Learning` 笔记类型
- 字段：Word, Phonetic, Meaning, SourceCode, Assimilation, Logic, Note, Example_En, Example_Cn

**practice_csv.py** - 练习卡片生成器
- 生成 7 字段 CSV 文件
- 对应 Anki 的 `English_Practice_Master` 笔记类型
- 每个笔记生成 3 张卡片（完形填空、拼写、情景问答）
- 字段：Word, Meaning, Cloze_Text, Cloze_Hint, Spell_Def, Scenario_Context, Scenario_Question

### 数据流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         处理流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │  input/  │───▶│ 文件扫描 │───▶│ 单词提取 │───▶│ 去重处理 │  │
│  │ *.txt    │    │          │    │          │    │          │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│                                                        │        │
│                                                        ▼        │
│  ┌──────────┐    ┌──────────┐    ┌──────────────────────────┐  │
│  │ output/  │◀───│ CSV生成  │◀───│     DeepSeek API 调用    │  │
│  │ *.csv    │    │          │    │   (每个单词独立请求)      │  │
│  └──────────┘    └──────────┘    └──────────────────────────┘  │
│                                                                  │
│  ┌──────────┐    ┌──────────┐                                   │
│  │processed/│◀───│ 文件归档 │                                   │
│  │ *_时间戳 │    │          │                                   │
│  └──────────┘    └──────────┘                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 错误处理策略

1. **API 调用失败**
   - 自动重试 3 次，每次间隔 1 秒
   - 重试失败后记录到失败列表，继续处理下一个单词
   - 最终汇总报告失败的单词

2. **文件操作错误**
   - 自动创建不存在的目录
   - 使用 UTF-8 编码确保中文正确处理

3. **配置错误**
   - 启动时检查 API 密钥是否配置
   - 未配置时给出明确提示

### 扩展性设计

- **模块化架构**：各模块职责单一，便于独立测试和扩展
- **配置集中管理**：所有配置项集中在 `config.py`，便于修改
- **接口抽象**：CSV 生成器使用类封装，便于扩展新的卡片类型
- **提示词外置**：API 提示词定义在 `deepseek.py` 顶部，便于优化调整
